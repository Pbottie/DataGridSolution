@typeparam TDataItem
@attribute [CascadingTypeParameter(nameof(TDataItem))]

<CascadingValue Value="this">
    <div class="d-flex flex-wrap gap-2 filter-container">
        @ChildContent
    </div>
    <div class="mx-3">
        @foreach (var filter in Filters)
        {
            if (filter.IsActive)
            {
                <span role="button" @key="filter" class="badge bg-secondary mx-1" @onclick="@(()=> filter.ClearFilter())">
                    X @filter.GetDisplayName: @(filter.FilterType == FilterTypes.MinMax ? @filter.FilterValue.Replace("_", " - ") : @filter.FilterValue)
                </span>
            }
        }
    </div>
</CascadingValue>


@code {

    [Parameter, EditorRequired]
    public IEnumerable<TDataItem> Items { get; set; }

    [Inject]
    public IFilter Filter { get; set; }

    IEnumerable<TDataItem> items { get; set; }

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    protected override void OnParametersSet()
    {
        if (items != Items)
        {
            items = Items;
            // Filter.NotifyAll();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Filter.NotifyAll();
        }
    }

    public List<FilterItem<TDataItem>> Filters = new();
    private Dictionary<string, string?> FieldDict { get; set; } = new();
    private Dictionary<string, FilterTypes> FilterTypeDict { get; set; } = new();


    public void AddFilterItem(FilterItem<TDataItem> filterItem)
    {
        if (filterItem != null)
        {
            Filters.Add(filterItem);

            var fieldName = filterItem.Field;

            if (filterItem.FilterType == FilterTypes.DateTimeMin || filterItem.FilterType == FilterTypes.DateTimeMax)
            {
                fieldName += filterItem.FilterType == FilterTypes.DateTimeMin ? "_Min" : "_Max";
            }

            FieldDict.Add(fieldName, filterItem.FilterValue);
            FilterTypeDict.Add(fieldName, filterItem.FilterType);
        }

        if (filterItem.FilterType == FilterTypes.MinMax)
        {
            var property = typeof(TDataItem).GetProperty(filterItem.Field);

            var min = int.Parse(items.Select(item => property.GetValue(item)).ToList().Min().ToString());
            var max = int.Parse(items.Select(item => property.GetValue(item)).ToList().Max().ToString());

            filterItem.SetFilterMinMax(min, max);
        }

        StateHasChanged();
    }

    public void UpdateFilter(FilterItem<TDataItem> filterItem)
    {
        var fieldName = filterItem.Field;


        if (filterItem.FilterType == FilterTypes.DateTimeMin || filterItem.FilterType == FilterTypes.DateTimeMax)
        {
            fieldName += filterItem.FilterType == FilterTypes.DateTimeMin ? "_Min" : "_Max";
        }

        if (FieldDict.Keys.Contains(fieldName))
            FieldDict[fieldName] = filterItem.FilterValue;

        StateHasChanged();
        Filter.NotifyAll();
    }

    public IEnumerable<TDataItem> FilteredItems
    {
        get
        {
            var result = items;
            var activeFilters = Filters.Where(filter => filter.IsActive);
            result = result
            .Where(x => IsFiltered(x))
            .ToList();

            return result;
        }
    }

    internal bool IsFiltered(TDataItem item)
    {
        //Radiobutton
        var result = true;
        foreach (var kvp in FieldDict)
        {
            var key = kvp.Key;

            if (key.Contains("_Min") || key.Contains("_Max"))
            {
                key = key.Split("_M")[0];
            }

            var activeFields = Filters
            .Where(filter => filter.IsActive)
            .Select(filter => filter.Field)
            .ToList();
            if (!activeFields.Contains(key) || kvp.Value == null)
            {
                continue;
            }
                       
            var property = typeof(TDataItem).GetProperty(key);
            var value = property.GetValue(item);

            if (FilterTypeDict[kvp.Key] == FilterTypes.String || FilterTypeDict[kvp.Key] == FilterTypes.RadioButton)
            {
                string stringValue = value.ToString().ToLower();
                var filterValue = kvp.Value.ToLower();
                if (!stringValue.Contains(filterValue))
                    return false;
            }
            else if (FilterTypeDict[kvp.Key] == FilterTypes.Int)
            {
                int intValue = (int)value;
                var filterValue = int.Parse(kvp.Value);
                if (intValue < filterValue)
                    return false;
            }
            else if (FilterTypeDict[kvp.Key] == FilterTypes.MinMax)
            {
                var minMaxValues = kvp.Value.ToString().Split("_");
                int min = int.Parse(minMaxValues[0]);
                int max = int.Parse(minMaxValues[1]);
                var intValue = int.Parse(value.ToString());
                if (intValue < min || intValue > max)
                    return false;
            }
            else if (FilterTypeDict[kvp.Key] == FilterTypes.DateTimeMin)
            {
                var dateValue = (DateTime)value;
                var filterValue = DateTime.Parse(kvp.Value);
                if (filterValue.IsAfterDate(dateValue))
                {
                    return false;
                }
            }
            else if (FilterTypeDict[kvp.Key] == FilterTypes.DateTimeMax)
            {
                var dateValue = (DateTime)value;
                var filterValue = DateTime.Parse(kvp.Value);
                if (filterValue.IsBeforeDate(dateValue))
                    return false;
            }
            else if (FilterTypeDict[kvp.Key] == FilterTypes.CheckBox)
            {
                var boolValue = value.ToString();
                var filterValue = kvp.Value.ToString();
                if (boolValue != filterValue)
                    return false;
            }

        }

        return result;
    }

}
